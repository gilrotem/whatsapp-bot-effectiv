# מסמך אפיון וארכיטקטורה - בוט WhatsApp ללידים (מחסנים)

**מצב נוכחי**: ינואר 2026

מסמך זה מתאר את הפיתוח, הארכיטקטורה והלוגיקה של המערכת שנבנתה. המטרה היא לאפשר המשך פיתוח או אינטגרציה עתידית מול סוכן AI אחר על סמך הבנה מלאה של המצב הקיים.

---

## 1. סקירת פרויקט (Overview)

מערכת לניהול שיחות אוטומטיות ב-WhatsApp שמטרתה סינון והעברת לידים (Lead Qualification) עבור עסק למכירת מחסני גינה. הבוט פועל כמכונת מצבים (State Machine) כדי לאסוף מידע מובנה מהלקוח לפני מעבר לנציג אנושי.

**מטרות עיקריות:**
1.  סינון ראשוני של סוג הפנייה (מכירות, שירות, בירור הזמנה).
2.  איסוף נתוני קולפיקציה עבור מכירות (גודל מחסן, תשתית רצפה, מיקום).
3.  שמירת הנתונים בבסיס נתונים.
4.  ניתוב השיחה לנציג אנושי בסיום התהליך או לפי דרישה.

---

## 2. ארכיטקטורה טכנולוגית (Tech Stack)

המערכת בנויה כשרת Webhook המאזין לאירועים מ-Meta (WhatsApp Cloud API).

*   **שפת פיתוח**: Node.js
*   **שרת אינטרנט**: Express.js
*   **בסיס נתונים**: PostgreSQL (ספריית `pg`)
*   **פלטפורמת אירוח (Deployment)**: Railway (מוגדר בשיטת Git-Push-to-Deploy).
*   **אינטגרציה ל-WhatsApp**: שימוש ישיר ב-WhatsApp Cloud API (ללא ספריות עוטפות צד ג' כמו Twilio).

**תרשים זרימה בסיסי:**
1.  הודעה נשלחת ע"י לקוח ב-WhatsApp.
2.  Meta מעבירה את ההודעה ל-Webhook שלנו (`POST /webhook`).
3.  Server מאתר/יוצר Session בבסיס הנתונים עבור המספר.
4.  Server בודק את המצב הנוכחי (Current State) ב-Session.
5.  State Machine מחליט על הפעולה הבאה (תגובה ללקוח + עדכון מצב חדש ב-DB).
6.  תשובה נשלחת חזרה ללקוח באמצעות `POST` ל-Graph API.

---

## 3. מודל נתונים (Data Model)

בסיס הנתונים מכיל שתי טבלאות עיקריות (`db.js`):

### טבלת Sessions (`sessions`)
מנהלת את הקשר הרציף עם הלקוח והמצב הנוכחי שלו בשיחה.
*   `phone_number` (PK, String): מזהה ייחודי של המשתמש.
*   `current_state` (String): המצב הנוכחי במכונת המצבים (ראו סעיף 4).
*   `intent` (String): סוג הפנייה (למשל: 'sales', 'support').
*   `shed_size` (String): העדפת גודל שנשמרה.
*   `flooring_status` (String): מצב תשתית (למשל: 'concrete', 'grass').
*   `city` (String): מיקום הלקוח.
*   `updated_at` (Timestamp): זמן פעילות אחרונה (לניהול Timeout בעתיד).

### טבלת Leads (`leads`)
היסטוריה של לידים שהושלמו. נתונים מועברים לכאן בסיום תהליך איסוף מוצלח.
*   `id` (PK, Serial)
*   `phone_number`
*   `intent`, `shed_size`, `flooring_status`, `city`
*   `created_at`

---

## 4. מכונת המצבים (State Machine Logic)

הלוגיקה ממומשת בקובץ `index.js` באמצעות מבנה `switch-case` מבוסס על ה-`current_state` של המשתמש.

### רשימת המצבים (States):

1.  **`STATE_WELCOME` (התחלה)**
    *   **תיאור**: מצב התחלתי למשתמש חדש או אחרי איפוס.
    *   **פעולה ללקוח**: שליחת הודעת ברוכים הבאים עם כפתורים (מכירות, הזמנה, שירות).
    *   **מעבר**: בחירה ב"מחסן" -> מעבר ל-`STATE_QUALIFY_SIZE`.

2.  **`STATE_QUALIFY_SIZE` (גודל)**
    *   **שאלה**: "מה גודל המחסן שאתה מחפש?"
    *   **אפשרויות**: קטן, בינוני, גדול.
    *   **שמירה**: ערך נשמר לשדה `shed_size`.
    *   **מעבר**: ל-`STATE_QUALIFY_FLOOR`.

3.  **`STATE_QUALIFY_FLOOR` (רצפה)**
    *   **שאלה**: "האם יש משטח קשיח (בטון/ריצוף)?"
    *   **אפשרויות**: כן, לא (אדמה), לא יודע.
    *   **שמירה**: ערך נשמר לשדה `flooring_status`.
    *   **לוגיקה מיוחדת**: אם התשובה שלילית (אדמה), ההודעה הבאה תכיל טיפ בנושא תשתית.
    *   **מעבר**: ל-`STATE_ASK_LOCATION`.

4.  **`STATE_ASK_LOCATION` (מיקום)**
    *   **שאלה**: "לאיזו עיר המשלוח?" (קלט טקסט חופשי).
    *   **שמירה**: הטקסט נשמר לשדה `city`.
    *   **מעבר**: ל-`STATE_SUMMARY_HANDOFF`.

5.  **`STATE_SUMMARY_HANDOFF` (סיום)**
    *   **פעולה**: שליחת הודעת סיכום ללקוח ("תודה, הפרטים התקבלו...").
    *   **Side Effect**: שמירת הליד בטבלת `leads` והתראה (לוגית) למנהל.
    *   **איפוס**: המצב חוזר ל-`STATE_WELCOME` או מצב רדום עד להתערבות אנושית.

6.  **`STATE_HUMAN_HANDOFF` (נציג)**
    *   **טריגר**: זיהוי מילות מפתח כמו "נציג", "אנושי".
    *   **פעולה**: עצירת הבוט ושליחת הודעה שנציג יצור קשר.

---

## 5. אינטגרציה ו-API (Integration APIs)

### נכנס (Inbound Webhook)
*   **Endpoint**: `POST /webhook`
*   **אימות (Verification)**: תהליך `GET /webhook` מול Meta המאמת את `hub.verify_token` (מוגדר בקובץ `.env` כ-`VERIFY_TOKEN`).
*   ** Payload**: מטופל בפורמט JSON סטנדרטי של Meta.

### יוצא (Outbound Messaging)
*   **Endpoint**: `https://graph.facebook.com/{VERSION}/{PHONE_NUMBER_ID}/messages`
*   **Headers**: `Authorization: Bearer {WHATSAPP_TOKEN}`
*   **סוגי הודעות בשימוש**:
    *   `type: text` - להודעות רגילות.
    *   `type: interactive` - לכפתורים (Buttons) משמש לניווט במכונת המצבים.

---

## 6. תהליכי עבודה וסקריפטים (Operational Scripts)

בתיקיית `scripts/` קיימים כלי עזר לתחזוקה שוטפת:
*   **`health_check.js`**: בדיקת זמינות השרת והגדרות בסיסיות.
*   **`simulate_webhook.js`**: מאפשר לדמות הודעה נכנסת (Post) לשרת הלוקאלי ללא צורך בשליחה מ-WhatsApp אמיתי (מעולה לטסטינג).
*   **`send_test_msg_v2.js`**: כלי לשליחת הודעה יזומה (בדיקת הטוקן וה-WABA ID).
*   **`backup_db.js`**: כלי לגיבוי מהיר של טבלאות ה-DB לקובץ JSON מקומי.

---

## 7. אפשרויות הרחבה עתידיות (Extensibility)

עבור סוכן AI שירצה להתממשק למערכת זו בעתיד:

1.  **קריאת סטטוס**: ניתן להתחבר ל-Database (Postgres) ולקרוא את טבלת `sessions` כדי להבין היכן המשתמש נמצא בשיחה.
2.  **הזרקת הודעות**: ניתן להשתמש בפונקציית `sendMessage` (או לממש endpoint פנימי חדש) כדי שהסוכן החכם ישלח הודעות מותאמות אישית במקום הטקסטים הקבועים של הבוט.
3.  **השתלטות (Takeover)**: ניתן להוסיף דגל ב-DB (`is_ai_agent_active: true`) שיגרום ל-`index.js` לדלג על הלוגיקה הסטנדרטית ולהעביר את ה-Webhook ישירות לעיבוד הסוכן החדש.
